---
title: "tcpl: Data Retrieval with tcpl via API"
author: US EPA's Center for Computational Toxicology and Exposure ccte@epa.gov
output:
  rmdformats::readthedown
params:
  my_css: css/rmdformats.css
vignette: >
  %\VignetteIndexEntry{5. Data Retrieval via APIs}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{css, code = readLines(params$my_css), hide=TRUE, echo = FALSE}
```

<img style="float: right; margin-left: 10px;" src="img/tcpl_hex.png" width="200">

```{r setup, include = FALSE}
devtools::load_all()
library(DT)
# helper function for printing
printFormattedTable <- function(res_dt, widen = c()) {
  datatable(res_dt, style = 'bootstrap', class = 'table-bordered table-condensed', rownames = FALSE, options = list(scrollX = TRUE, autoWidth = TRUE, dom = 't', columnDefs = list(list(width = '1000px', targets = widen))))
}
library(httptest)
start_vignette("api")
```

# Introduction

This vignette describes how the user can retrieve ToxCast data (invitrodb) from the [Computational Toxicology and Exposure APIs (CTX APIs)](https://www.epa.gov/comptox-tools/computational-toxicology-and-exposure-apis) using <font face="CMTT10">tcpl</font>. <font face="CMTT10">tcpl</font> interfaces with the CTX Bioactivity API through the [<font face="CMTT10">ctxR</font> R Client package](<https://cran.r-project.org/web/packages/ctxR>), which wraps the API endpoints and provides helpful functions for storing meta-information related to your connection.

# Establishing API Connection

After loading <font face="CMTT10">tcpl</font>, the function <font face="CMTT10">tcplConf</font> is used to establish connection to a database server or the API. While a typical database connection requires 5 parameters to be provided, using an API connection requires the user to only specify password (`pass`) and driver (`drvr`):

```{r setup-api}
tcplConf(pass = "API key provided by emailing CTX API support at ccte_api@epa.gov>",
         drvr = "API")
```

::: {.noticebox data-latex=""}

**NOTE:** When <font face="CMTT10">tcpl</font> is loaded, the default configuration sets the options to <font face="CMTT10">tcpl</font>'s application API key to support new users testing out the package. This default API key is not intended for regular users; instead, it is highly recommended to obtain a personal API key to also access other CTX APIs. For this, send an email request to CTX API support at <ccte_api@epa.gov>.

:::

# Overview of Key Functions

To support different ToxCast data retrieval needs, there are a number of <font face="CMTT10">tcpl</font> functions that can be used to query the API and return information to a local R environment.

Throughout this vignette, abbreviations may be used to refer to processing steps or data. Single-concentration 'SC' assay data is not currently available via API. ‘MC’ describes multiple-concentration assay data. A particular data or processing level is indicated by appending the level id/number to the end of the ‘SC’ or ‘MC’ designation. For example, multiple concentration data from level 3 processing uses the abbreviation ‘MC3.’

## Assay Elements

The <font face="CMTT10">**tcplLoadAsid, tcplLoadAid, tcplLoadAcid**</font>, and <font face="CMTT10">**tcplLoadAeid**</font> functions load relevant ids and names for the respective assay elements based on the user specified parameters. 

```{r tcplLoad, eval = FALSE}
# List all assay source IDs
tcplLoadAsid() 
# Create table of all assay endpoint ids (aeids) per assay source
aeids <- tcplLoadAeid(fld="asid", # field to query on
                      val=14, # value for each field
                              # values should match their corresponding 'fld'
                      add.fld = c("aid", "anm", "acid", "acnm")) # additional fields to return
```

## Data

<font face="CMTT10">**tcplQueryAPI**</font> is a general querying function which is flexible enough to handle most kinds of queries users may have for the API. Unlike <font face="CMTT10">tcplQuery</font>, <font face="CMTT10">tcplQueryAPI</font> does not accept a MySQL query but instead has a few arguments which can be set to mimic a request to the various API endpoints. <font face="CMTT10">tcplQueryAPI</font> is used mostly as a helper function to other <font face="CMTT10">tcplLoad</font> functions, but is available to users for more specific and/or personalized requests.

```{r tcplQueryAPI, eval = FALSE}
# Request and load all assays+annotations for specified asid
data <- tcplQueryAPI(resource = "data", # resource to query from API, either 'data' or 'assay'
                     fld = "aeid", val = 891, # field and val to query on
                     return_fld = c("spid", "chnm", "hitcall")) # specify the return fields, leave NULL for all fields
```

The <font face="CMTT10">**tcplLoadData**</font> function can be used to load data from the CTX APIs into the R environment. **Only MC levels 3, 4, 5, 6, and 'agg' are currently available via the API**. To add chemical and assay annotation information, and data from every level mapped to the retrieved data, set `add.fld = TRUE` (this is the default). The output with `add.fld = FALSE` will look as similar to the tcplLoadData output by level from a database connection, though some less known columns may not be available and the column order may differ.

```{r tcplLoadData, eval=FALSE}
# Load multi concentration data from level 4
mc4_dat <- tcplLoadData(
    lvl = 4, # data level
    fld = 'aeid', # field to query on
    val = 891, # value for each field
             # values should match their corresponding 'fld'
    type = 'mc', # data type, default, not necessary
    add.fld = FALSE # FALSE will only show fields/columns which are usually
                    # returned for this level, default TRUE will return all available
  )
```

When loading data, the user must indicate the applicable fields and ids which are query-able via the CTX Bioactivity API. These such fields are limited to "aeid", "m4id", "spid", and "dtxsid", and any other fields will result in error. While supplying multiple ids (through `val`) are valid, multiple fields are not. Combinations of fields are currently not supported with <font face="CMTT10">tcplLoadData</font> using an API connection. <font face="CMTT10">tcplLoadData</font> will return whatever data is found, and list in output if any val(s) were not found or contain no data to be returned. Examples of loading data are detailed in later sections.

## Assay Annotations

Assay source, assay, assay component, and assay endpoint are registered via tcpl scripting into a collection of database tables within invitrodb. For the API, these tables were joined to create a singular "assay" annotations view, which can be returned using <font face="CMTT10">tcplQueryAPI</font>. The annotations capture four types of information:

i. Identification information
ii. Design information such as the technology, format, and objective aspects that decompress the assay’s innovations
iii. Target information, such as the target of technological measurement, biological intended target, and biological process
iv. Analysis information about how the data were processed and analyzed

```{r annotation_query_ex, eval = FALSE}
# load all assays and their annotations
assays <- tcplQueryAPI(resource = "assay")
```

# Retrieving Processed Multi-Concentration (MC) Data and Annotations

As described in greater detail within the processing vignette, a goal of MC processing is to derive the efficacy and potency estimates for for each modeled endpoint-sample dose response. API data is available for levels 3 through 6, herein users can inspect the MC data including efficacy and potency estimates, model parameters, raw concentration response values, cautionary flags, and applied methods.

## Data

Loading data is can be done for a given endpoint (aeid), sample (spid), chemical (dtxsid), or endpoint-sample (m4id) by specifying "fld". Set add.fld = FALSE is used to limit fields to those which are defaults for each level when loading from invitrodb directly. Leaving add.fld = TRUE (default) will return all available fields, i.e. all information from levels 3 through 6.

### By aeid
```{r data_by_aeid}
# Load Level 5 MC data for an aeid
mc5 <- tcplLoadData(lvl=5,    # data level
               fld="aeid",    # fields to query on
               val=704,       # values should match their corresponding 'fld'
               type = "mc",   # data type, default, not needed
               add.fld=FALSE) # restrict to just level 5 parameters 
```

```{r, echo = FALSE}
printFormattedTable(mc5)
```
### By spid
```{r data_by_spid}
# Load Level 5 MC data for an aeid
mc5 <- tcplLoadData(lvl=5,         # data level
               fld="spid",         # fields to query on
               val="TP0000904H05", # values should match their corresponding 'fld'
               type = "mc",        # data type, default, not needed
               add.fld=FALSE)      # restrict to just level 5 parameters
```

```{r, echo = FALSE}
printFormattedTable(mc5)
```
### By m4id
```{r data_by_m4id}
# Load Level 5 MC data for an aeid
mc5 <- tcplLoadData(lvl=5,    # data level
               fld="m4id",    # fields to query on
               val=1842443,   # values should match their corresponding 'fld'
               type = "mc",   # data type, default, not needed
               add.fld=FALSE) # restrict to just level 5 parameters
```

```{r, echo = FALSE}
printFormattedTable(mc5)
```
### By DTXSID
```{r data_by_dtxsid}
# Load Level 5 MC data for an aeid
mc5 <- tcplLoadData(lvl=5,           # data level
               fld="dtxsid",         # fields to query on
               val="DTXSID30944145", # values should match their corresponding 'fld'
               type = "mc",          # data type, default, not needed
               add.fld=FALSE)        # restrict to just level 5 parameters
```

```{r, echo = FALSE}
printFormattedTable(mc5)
```
### By level

In addition to level 5 data, levels 3, 4, 6, and 'agg' are available to pull from the API.

#### mc3

```{r data_level_3}
mc3 <- tcplLoadData(lvl=3,    # data level
               fld="m4id",    # fields to query on
               val=1842443,   # values should match their corresponding 'fld'
               type = "mc",   # data type, default, not needed
               add.fld=FALSE) # restrict to just level 3 parameters  
```

```{r, echo = FALSE}
printFormattedTable(mc3)
```

#### mc4

```{r data_level_4}
mc4 <- tcplLoadData(lvl=4,    # data level
               fld="m4id",    # fields to query on
               val=1842443,   # values should match their corresponding 'fld'
               type = "mc",   # data type, default, not needed
               add.fld=FALSE) # restrict to just level 4 parameters 
```

```{r, echo = FALSE}
printFormattedTable(mc4)
```

#### mc6

```{r data_level_6}
mc6 <- tcplLoadData(lvl=6,    # data level
               fld="m4id",    # fields to query on
               val=1842443,   # values should match their corresponding 'fld'
               type = "mc",   # data type, default, not needed
               add.fld=FALSE) # restrict to just level 6 parameters 
```

```{r, echo = FALSE}
printFormattedTable(mc6, 17)
```

#### agg

```{r data_level_agg}
agg <- tcplLoadData(lvl="agg", # data level
               fld="m4id",     # fields to query on
               val=1842443,    # values should match their corresponding 'fld'
               type = "mc",    # data type, default, not needed
               add.fld=FALSE)  # restrict to just agg level parameters 
```

```{r, echo = FALSE}
printFormattedTable(agg)
```

### add.fld = TRUE

```{r data_level_5_all}
all_fields <- tcplLoadData(lvl=3,    # data level
               fld="m4id",    # fields to query on
               val=1842443,   # values should match their corresponding 'fld'
               type = "mc",   # data type, default, not needed
               add.fld=TRUE)  # include all fields 
```

```{r, echo = FALSE}
printFormattedTable(all_fields, 175)
```

## Assay Annotations

The tcplLoadAsid, tcplLoadAid, tcplLoadAcid, and tcplLoadAeid functions load relevant assay ids and names for the respective assay elements based on the user specified parameters.

### Load aeid

<font face="CMTT10">tcplLoadAeid</font> is used to load endpoint id (aeid) and endpoint name (aenm) as well any mapped annotations. Any annotations field can be used in the "fld" and "val" parameters to produce an annotations subset. Users may consider reviewing all annotations via tcplQueryAPI(resource = "assay") if unsure which values to supply.

```{r load_aeid}
# load aeid and aenm for given acid
aeid <- tcplLoadAeid(fld = "acid", val = 400)
```

```{r, echo = FALSE}
printFormattedTable(aeid)
```

Users may subset on as many fields as desired. <font face="CMTT10">tcplLoadAeid</font> joins the criteria with multiple `fld` and `val` as an “AND” rather than “OR”, meaning the subset returns rows where all are TRUE. `val` has the same length that `fld`. To combine fields of different types (i.e. numeric and string), or of different element lengths (list(“protein”, c(“Colorimetric”, “Fluorescence”))), ensure all values are provided in appropriate length lists.

```{r load_aeid_plus}
# subset all aeids by using multiple fields -- val must be same length in list form!
aeids <- tcplLoadAeid(fld = c("intended_target_type", "detection_technology_type"), 
                      val = list("protein", c("Colorimetric", "Fluorescence"))) # list length == 2!
```

```{r, echo = FALSE}
printFormattedTable(aeids)
```

### Load acid

Similar to <font face="CMTT10">tcplLoadAeid</font>, <font face="CMTT10">tcplLoadAcid</font> loads assay component id (acid) and assay component name (acnm) as well as any specified annotation fields. Like <font face="CMTT10">tcplLoadAeid</font>, output can be subset with as many `fld` and `val` as desired.

```{r load_acid}
# load acid and acnm for given aeid
acid <- tcplLoadAcid(fld = "aeid", val = c(663,891))
```

```{r, echo = FALSE}
printFormattedTable(acid)
```

```{r load_acid_all}
# subset all acids by using multiple fields -- val must be same length in list form!
acids <- tcplLoadAcid(fld = c("organism", "tissue"), 
                      val = list("rat", "liver"),
                      add.fld = c("aeid", "aid", "asid", "signal_direction")) 
```

```{r, echo = FALSE}
printFormattedTable(acids)
```

### Load aid

Similar to <font face="CMTT10">tcplLoadAeid</font>, <font face="CMTT10">tcplLoadAid</font> loads assay id (aid) and assay name (anm) as well as any specified annotation fields. Like <font face="CMTT10">tcplLoadAeid</font>, output can be subset with as many `fld` and `val` as desired.

```{r load_aid}
# load aid and anm for given aeid
aid <- tcplLoadAid(fld = "aeid", val = 663)
```

```{r, echo = FALSE}
printFormattedTable(aid)
```

```{r load_aid_all}
# subset all aids by using multiple fields -- val must be same length in list form!
aids <- tcplLoadAid(fld = c("organism", "tissue"), 
                      val = list("rat", "liver"),
                      add.fld = c("aeid", "acid", "asid", "signal_direction")) 
```

```{r, echo = FALSE}
printFormattedTable(aids)
```

### Load asid

Similar to <font face="CMTT10">tcplLoadAeid</font>, <font face="CMTT10">tcplLoadAsid</font> loads assay source id (asid) and assay source name (asnm) as well as any specified annotation fields. Like <font face="CMTT10">tcplLoadAsid</font>, output can be subset with as many `fld` and `val` as desired.

```{r load_asid}
# load asid and asnm for given aeid
asid <- tcplLoadAsid(fld = "aeid", val = 663)
```

```{r, echo = FALSE}
printFormattedTable(asid)
```

```{r load_asid_all}
# subset all asids by using multiple fields -- val must be same length in list form!
asids <- tcplLoadAsid(fld = c("organism", "tissue"), 
                      val = list("rat", "liver"),
                      add.fld = c("aeid", "acid", "asid", "signal_direction")) 
```

```{r, echo = FALSE}
printFormattedTable(asids)
```

### Load unit

To load the normalized data type, or response unit, use <font face="CMTT10">tcplLoadUnit</font>. This function does not require `fld` and `val` parameters, but uses `aeid` as input. <font face="CMTT10">tcplLoadUnit</font> is typically used as an internal function for plotting.

```{r load_unit}
# load resp_unit for given aeid
unit <- tcplLoadUnit(aeid = c(663, 891))
```

```{r, echo = FALSE}
printFormattedTable(unit)
```

## Sample and Chemical information

### Load concentration unit

<font face="CMTT10">tcplLoadConcUnit</font> is used to load the concentration unit for a specific `spid` or multiple `spid`s. This is typically used as an internal function for plotting.

```{r load_conc_unit}
# load conc_unit for given spid
conc_unit <- tcplLoadConcUnit(spid = "TP0000904H05")
```

```{r, echo = FALSE}
printFormattedTable(conc_unit)
```

### Load chemical info

<font face="CMTT10">tcplLoadChem</font> is used to load the chemical information for a specific `spid` or multiple `spid`s. Notice tcplLoadChem uses `field` instead of `fld`.

```{r load_chem}
# load chem_info for given spid
chem_info <- tcplLoadChem(field = "spid", val = "TP0000904H05")
```

```{r, echo = FALSE}
printFormattedTable(chem_info)
```

# Plotting

<font face="CMTT10">tcplPlot</font> is tcpl’s single flexible plotting function, allowing for interactive and consistent visualization of concentration-response curves via customizable parameters. For more details on implementation, parameters and specific customization instructions, refer to the main Data Retrieval vignette. This section will instead focus on the limitations of plotting using the CTX APIs as a data connection.

As with loading data via <font face="CMTT10">tcplLoadData</font>, the user must indicate the applicable fields and ids which are query-able via the CTX Bioactivity API. These such fields are limited to “aeid”, “m4id”, “spid”, and “dtxsid”, and any other fields input will result in error.

While supplying multiple ids (through val) are valid, but multiple fields are not. For example, if fld = "spid", no aeid can be specified, meaning every matching spid will be plotted. If fld = "aeid", every sample within the given endpoint(s) will be plotted. If fld = "m4id", only one plot will output for every each m4id input. Combinations of fields are currently not supported with tcplPlot using API connections. Therefore, if looking for a specific aeid and spid combo, one should determine the corresponding m4id, like so:

## Output Image File (JPG) of Single Verbose Plot, by M4ID

```{r plot_aeid_spid, eval = FALSE}
# load all matching spids and then subset using the aeid desired to find m4id
mc5 <- tcplLoadData(lvl = 5, 
                    fld = "spid",
                    val = "TP0000904H05",
                    type = "mc", 
                    add.fld = FALSE) # 8 rows of data
m4id <- mc5[aeid == 714]$m4id # subset to 1 aeid extract m4id

# default parameters used here: fld = "m4id", type = "mc" (type can never be "sc" when connected to API)
tcplPlot(val = m4id, output = "jpg", verbose = TRUE, flags = TRUE)
```

<center>![<font style="font-size:15px"><i>API-sourced plot with parameters: output = "jpg", verbose = TRUE, and flags = TRUE for m4id 1847540</i></font>](img/API_plot_1847540.jpg)</center>

## Output PDF of Multiple Comparison Plots per Page, by M4ID

The “compare"/dual-plot feature can be used by supplying a list of m4ids to `val` and `compare.val`. These lists must be the same length!

```{r plot_m4id_compare, eval = FALSE}
# using the data pulled in the previous code chunk 'mc5'
m4id <- mc5$m4id # create m4id vector length == 8

# default parameters used here: fld = "m4id", type = "mc" (type can never be "sc" when connected to API)
tcplPlot(val = m4id[1:4], 
         compare.val = m4id[5:8], 
         output = "pdf", 
         verbose = TRUE, 
         multi = TRUE, 
         flags = TRUE, 
         yuniform = TRUE,
         fileprefix = "API_plot_compare")
```

<center>![<font style="font-size:15px"><i>API-sourced plots with parameters: output = "pdf", verbose = TRUE, multi = TRUE, flags = TRUE, and yuniform = TRUE for m4ids 1833668, 1834094, 1836233, and 1836494, compared with m4ids 1839401, 1842443, 1847540, and 1850045</i></font>](img/API_plot_compare.png)</center>

## Output PDF of Verbose, Multiple Plots per Page, by AEID

Supply `fld = "aeid"` to plot every curve available in the API for the given endpoint(s).

```{r plot_aeid, eval = FALSE}
# plot all curves across endpoint(s)
tcplPlot(fld = "aeid", 
         val = 704, 
         output = "pdf", 
         verbose = TRUE, 
         multi = TRUE, 
         yrange = c(-100,100),
         fileprefix = "API_plot_704")
```

<center>![<font style="font-size:15px"><i>API-sourced plots with parameters: output = "pdf", verbose = TRUE, multi = TRUE, and yrange = c(-100,100) for aeid 704</i></font>](img/API_plot_704.png)</center>

## Advanced Comparison Plotting

<font face="CMTT10">tcplPlot</font> has been updated for advanced comparison plotting across data connections. If working on a local invitrodb instance, additional dose-response data may be available, data reprocessed, methods adjusted, etc. Users may wish to compare data released in different versions, such as comparing API data or versioned database (invitrodb v4.1 and later) to one's local invitrodb database.

Using the utility function <font face="CMTT10">tcplPlotLoadData</font> while connected to the API, users can pass along data via <font face="CMTT10">tcplPlot</font>’s `dat` parameter and use `compare.val` for their database data.

```{r plot_standalone, eval = FALSE}
# while connected to the CTX Bioacivity API using tcplConf
api_data <- tcplPlotLoadData(lvl = 5, fld = "aeid", val = 704, type = "mc", flags = TRUE)

# fill with database connection information
tcplConf(user="", pass="", db="", drvr="", host="")

# plot all comparisons of samples from the same endpoint across two database versions
tcplPlot(dat = api_data,
         fld = "aeid", 
         val = 704, 
         compare.val = 704,
         output = "pdf", 
         verbose = TRUE, 
         multi = TRUE, 
         flags = TRUE,
         fileprefix = "API_plot_standalone")
```

<center>![<font style="font-size:15px"><i>API-sourced plots with parameters: dat = api_data from tcplPlotLoadData(), output = "pdf", verbose = TRUE, multi = TRUE, and flags = TRUE for comparison of aeid 704 to current database version</i></font>](img/API_plot_standalone.png)</center>

```{r, include=FALSE}
end_vignette()
```